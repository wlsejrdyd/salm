<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('ì˜· ë“±ë¡')}"></head>
<body class="bg-gray-50 min-h-screen">
    <header th:replace="~{fragments/header :: header}"></header>

    <main class="max-w-2xl mx-auto px-4 py-8">
        <div class="bg-white rounded-2xl shadow-sm p-6 md:p-8">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">ì˜· ë“±ë¡</h1>

            <form id="clothForm">
                <!-- ìƒí’ˆ ë§í¬ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ìƒí’ˆ ë§í¬ 
                        <span class="text-gray-400 font-normal">(ì¿ íŒ¡, ë¬´ì‹ ì‚¬ ë“±)</span>
                    </label>
                    <div class="flex space-x-2">
                        <input type="url" name="productUrl" id="productUrl"
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                               placeholder="https://www.musinsa.com/...">
                        <button type="button" onclick="scrapeLink()" 
                                class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 whitespace-nowrap">
                            ìë™ì…ë ¥
                        </button>
                    </div>
                    <p class="text-sm text-gray-400 mt-1">ë§í¬ë¥¼ ì…ë ¥í•˜ë©´ ì´ë¯¸ì§€ì™€ ì´ë¦„ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤</p>
                </div>

                <!-- ì´ë¯¸ì§€ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‚¬ì§„</label>
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-emerald-400">
                        <input type="file" name="image" id="imageInput" accept="image/*" class="hidden">
                        <div id="placeholder">
                            <span class="text-3xl">ğŸ“·</span>
                            <p class="mt-2 text-gray-500 text-sm">í´ë¦­í•´ì„œ ì—…ë¡œë“œ ë˜ëŠ” ë§í¬ì—ì„œ ìë™</p>
                        </div>
                        <img id="preview" class="hidden max-h-40 mx-auto rounded-lg" alt="">
                    </div>
                </div>

                <!-- ì¹´í…Œê³ ë¦¬ (ëŒ€ë¶„ë¥˜ë³„ ê·¸ë£¹) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">ì¹´í…Œê³ ë¦¬ <span class="text-red-500">*</span></label>
                    
                    <!-- ì•„ìš°í„° -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">ğŸ§¥ ì•„ìš°í„°</p>
                        <div class="flex flex-wrap gap-2">
                            <th:block th:each="cat : ${categories}">
                                <label th:if="${cat.parentType == 'outer'}" class="category-btn">
                                    <input type="radio" name="categoryId" th:value="${cat.id}" class="hidden" required>
                                    <span class="inline-block px-4 py-2 border border-gray-200 rounded-full cursor-pointer hover:border-emerald-400 transition text-sm"
                                          th:text="${cat.name}">íŒ¨ë”©</span>
                                </label>
                            </th:block>
                        </div>
                    </div>

                    <!-- ìƒì˜ -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">ğŸ‘• ìƒì˜</p>
                        <div class="flex flex-wrap gap-2">
                            <th:block th:each="cat : ${categories}">
                                <label th:if="${cat.parentType == 'tops'}" class="category-btn">
                                    <input type="radio" name="categoryId" th:value="${cat.id}" class="hidden" required>
                                    <span class="inline-block px-4 py-2 border border-gray-200 rounded-full cursor-pointer hover:border-emerald-400 transition text-sm"
                                          th:text="${cat.name}">í‹°ì…”ì¸ </span>
                                </label>
                            </th:block>
                        </div>
                    </div>

                    <!-- í•˜ì˜ -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">ğŸ‘– í•˜ì˜</p>
                        <div class="flex flex-wrap gap-2">
                            <th:block th:each="cat : ${categories}">
                                <label th:if="${cat.parentType == 'bottoms'}" class="category-btn">
                                    <input type="radio" name="categoryId" th:value="${cat.id}" class="hidden" required>
                                    <span class="inline-block px-4 py-2 border border-gray-200 rounded-full cursor-pointer hover:border-emerald-400 transition text-sm"
                                          th:text="${cat.name}">ì²­ë°”ì§€</span>
                                </label>
                            </th:block>
                        </div>
                    </div>

                    <!-- ì‹ ë°œ -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">ğŸ‘Ÿ ì‹ ë°œ</p>
                        <div class="flex flex-wrap gap-2">
                            <th:block th:each="cat : ${categories}">
                                <label th:if="${cat.parentType == 'shoes'}" class="category-btn">
                                    <input type="radio" name="categoryId" th:value="${cat.id}" class="hidden" required>
                                    <span class="inline-block px-4 py-2 border border-gray-200 rounded-full cursor-pointer hover:border-emerald-400 transition text-sm"
                                          th:text="${cat.name}">ìš´ë™í™”</span>
                                </label>
                            </th:block>
                        </div>
                    </div>

                    <!-- ì•…ì„¸ì„œë¦¬ -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-500 mb-2">ğŸ’ ì•…ì„¸ì„œë¦¬</p>
                        <div class="flex flex-wrap gap-2">
                            <th:block th:each="cat : ${categories}">
                                <label th:if="${cat.parentType == 'accessories'}" class="category-btn">
                                    <input type="radio" name="categoryId" th:value="${cat.id}" class="hidden" required>
                                    <span class="inline-block px-4 py-2 border border-gray-200 rounded-full cursor-pointer hover:border-emerald-400 transition text-sm"
                                          th:text="${cat.name}">ëª¨ì</span>
                                </label>
                            </th:block>
                        </div>
                    </div>
                </div>

                <!-- ì´ë¦„ (ì„ íƒ) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ <span class="text-gray-400">(ì„ íƒ)</span></label>
                    <input type="text" name="name" id="nameInput"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                           placeholder="ì˜ˆ: ê²€ì • ë¡±íŒ¨ë”©">
                </div>

                <!-- ë¸Œëœë“œ & ìƒ‰ìƒ -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¸Œëœë“œ</label>
                        <input type="text" name="brand" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒ‰ìƒ</label>
                        <input type="text" name="color" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button type="submit" id="submitBtn" class="flex-1 bg-emerald-500 text-white py-3 rounded-lg font-medium hover:bg-emerald-600">ë“±ë¡</button>
                    <a href="/closet" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 text-center">ì·¨ì†Œ</a>
                </div>
            </form>
        </div>
    </main>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <style>
        .category-btn input:checked + span {
            border-color: #10b981;
            background-color: #ecfdf5;
            color: #059669;
        }
    </style>

    <script>
        const dropZone = document.getElementById('dropZone');
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder');

        dropZone.onclick = () => imageInput.click();
        imageInput.onchange = e => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = e => showPreview(e.target.result);
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        function showPreview(src) {
            preview.src = src;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
        }

        async function scrapeLink() {
            const url = document.getElementById('productUrl').value;
            if (!url) { alert('ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

            const btn = event.target;
            btn.textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/closet/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();

                if (data.success && data.data) {
                    if (data.data.imageUrl) showPreview(data.data.imageUrl);
                    if (data.data.title) document.getElementById('nameInput').value = data.data.title;
                    alert('ì •ë³´ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
                } else {
                    alert('ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                alert('ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.textContent = 'ìë™ì…ë ¥';
                btn.disabled = false;
            }
        }

        document.getElementById('clothForm').onsubmit = async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const btn = document.getElementById('submitBtn');
            btn.textContent = 'ë“±ë¡ ì¤‘...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/closet/clothes', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.success) {
                    alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.href = '/closet/wardrobe';
                } else {
                    alert(data.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.textContent = 'ë“±ë¡';
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
