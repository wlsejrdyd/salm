<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <th:block th:replace="~{fragments/layout :: head(${post.title})}"/>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

<th:block th:replace="~{fragments/layout :: header}"/>

<main class="flex-1 py-8">
    <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm">
            <ol class="flex items-center space-x-2 text-gray-500">
                <li><a th:href="@{/}" class="hover:text-primary">í™ˆ</a></li>
                <li><span>/</span></li>
                <li><a th:href="@{/posts}" class="hover:text-primary">ê²Œì‹œê¸€</a></li>
                <li><span>/</span></li>
                <li><a th:href="@{/category/{cat}(cat=${post.category})}" th:text="${post.category}" class="hover:text-primary">ì¹´í…Œê³ ë¦¬</a></li>
            </ol>
        </nav>

        <!-- Post Header -->
        <header class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <span th:text="${post.category}" 
                  class="inline-block px-3 py-1 text-sm font-medium text-primary bg-primary/10 rounded-full mb-4"></span>
            
            <h1 th:text="${post.title}" class="text-2xl md:text-3xl font-bold text-gray-900 mb-4">ì œëª©</h1>
            
            <div class="flex flex-wrap items-center justify-between gap-4 text-gray-500">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white">
                            <span th:text="${#strings.substring(post.authorName, 0, 1)}">U</span>
                        </div>
                        <div>
                            <p th:text="${post.authorName}" class="font-medium text-gray-900">ì‘ì„±ì</p>
                            <p th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd HH:mm')}" class="text-sm">ë‚ ì§œ</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 text-sm">
                    <span>ğŸ‘ï¸ ì¡°íšŒ <span th:text="${post.viewCount}">0</span></span>
                    <span>â¤ï¸ ì¢‹ì•„ìš” <span th:text="${post.likeCount}" id="likeCount">0</span></span>
                    <span>ğŸ’¬ ëŒ“ê¸€ <span th:text="${post.commentCount}">0</span></span>
                </div>
            </div>
        </header>

        <!-- Post Content -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <!-- Images -->
            <div th:if="${post.images != null and !post.images.empty}" class="mb-6">
                <div class="grid grid-cols-1 gap-4">
                    <img th:each="img : ${post.images}" 
                         th:src="@{/data/{path}(path=${img})}"
                         alt="" class="w-full rounded-lg">
                </div>
            </div>
            
            <!-- Text Content -->
            <div th:utext="${post.content}" class="prose max-w-none text-gray-700 whitespace-pre-wrap">
                ë‚´ìš©
            </div>
            
            <!-- Product Link (ìˆì„ ê²½ìš°) -->
            <div th:if="${post.productUrl}" class="mt-6 p-4 bg-gray-50 rounded-lg border">
                <p class="text-sm text-gray-500 mb-2">ê´€ë ¨ ìƒí’ˆ</p>
                <a th:href="${post.productUrl}" target="_blank" rel="noopener"
                   class="text-primary hover:underline flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                    ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°
                </a>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div class="flex items-center space-x-3">
                <button onclick="toggleLike()" id="likeBtn"
                        th:classappend="${post.liked} ? 'bg-red-50 text-red-500 border-red-200' : 'bg-white text-gray-600'"
                        class="px-4 py-2 border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition">
                    <span th:text="${post.liked} ? 'â¤ï¸' : 'ğŸ¤'">ğŸ¤</span>
                    <span>ì¢‹ì•„ìš”</span>
                </button>
                
                <button onclick="toggleBookmark()" id="bookmarkBtn"
                        th:classappend="${post.bookmarked} ? 'bg-yellow-50 text-yellow-600 border-yellow-200' : 'bg-white text-gray-600'"
                        class="px-4 py-2 border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition">
                    <span th:text="${post.bookmarked} ? 'â­' : 'â˜†'">â˜†</span>
                    <span>ë¶ë§ˆí¬</span>
                </button>
                
                <button onclick="sharePost()" 
                        class="px-4 py-2 bg-white border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition">
                    <span>ğŸ”—</span>
                    <span>ê³µìœ </span>
                </button>
            </div>
            
            <!-- Edit/Delete (ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ) -->
            <div sec:authorize="isAuthenticated()" 
                 th:if="${#authentication.principal.userId == post.authorId or #authentication.principal.user.admin}"
                 class="flex items-center space-x-2">
                <a th:href="@{/posts/{id}/edit(id=${post.id})}"
                   class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">ìˆ˜ì •</a>
                <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" 
                      onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">ì‚­ì œ</button>
                </form>
            </div>
        </div>

        <!-- Comments Section -->
        <section class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold text-gray-900 mb-6">
                ğŸ’¬ ëŒ“ê¸€ <span th:text="${#lists.size(comments)}" class="text-primary">0</span>
            </h2>
            
            <!-- Comment Form -->
            <div sec:authorize="isAuthenticated()" class="mb-6">
                <form id="commentForm" class="flex space-x-3">
                    <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <button type="submit" 
                            class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition">
                        ë“±ë¡
                    </button>
                </form>
            </div>
            
            <div sec:authorize="!isAuthenticated()" class="mb-6 p-4 bg-gray-50 rounded-lg text-center">
                <a th:href="@{/login}" class="text-primary hover:underline">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <!-- Comment List -->
            <div id="commentList" class="space-y-4">
                <div th:each="comment : ${comments}" class="border-b pb-4 last:border-0">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-sm">
                            <span th:text="${#strings.substring(comment.authorName, 0, 1)}">U</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span th:text="${comment.authorName}" class="font-medium text-gray-900">ì‘ì„±ì</span>
                                <span th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}" 
                                      class="text-sm text-gray-400">ë‚ ì§œ</span>
                            </div>
                            <p th:text="${comment.content}" 
                               th:classappend="${comment.deleted} ? 'text-gray-400 italic' : 'text-gray-700'"
                               class="text-sm">ë‚´ìš©</p>
                            
                            <!-- Replies -->
                            <div th:if="${comment.replies != null and !comment.replies.empty}" class="mt-4 ml-4 space-y-3">
                                <div th:each="reply : ${comment.replies}" class="flex items-start space-x-3 bg-gray-50 p-3 rounded-lg">
                                    <div class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-xs">
                                        <span th:text="${#strings.substring(reply.authorName, 0, 1)}">U</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span th:text="${reply.authorName}" class="font-medium text-gray-900 text-sm">ì‘ì„±ì</span>
                                            <span th:text="${#temporals.format(reply.createdAt, 'yyyy.MM.dd HH:mm')}" 
                                                  class="text-xs text-gray-400">ë‚ ì§œ</span>
                                        </div>
                                        <p th:text="${reply.content}" class="text-sm text-gray-700">ë‚´ìš©</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div th:if="${comments == null or comments.empty}" class="text-center py-8 text-gray-500">
                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                </div>
            </div>
        </section>
    </article>
</main>

<th:block th:replace="~{fragments/layout :: footer}"/>

<script th:inline="javascript">
    const postId = [[${post.id}]];
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    
    // ì¢‹ì•„ìš” í† ê¸€
    async function toggleLike() {
        try {
            const response = await fetch(`/api/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                const btn = document.getElementById('likeBtn');
                const count = document.getElementById('likeCount');
                
                if (result.data) {
                    btn.innerHTML = '<span>â¤ï¸</span><span>ì¢‹ì•„ìš”</span>';
                    btn.className = 'px-4 py-2 border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition bg-red-50 text-red-500 border-red-200';
                    count.textContent = parseInt(count.textContent) + 1;
                } else {
                    btn.innerHTML = '<span>ğŸ¤</span><span>ì¢‹ì•„ìš”</span>';
                    btn.className = 'px-4 py-2 border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition bg-white text-gray-600';
                    count.textContent = Math.max(0, parseInt(count.textContent) - 1);
                }
            } else if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    // ë¶ë§ˆí¬ í† ê¸€
    async function toggleBookmark() {
        try {
            const response = await fetch(`/api/posts/${postId}/bookmark`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                const btn = document.getElementById('bookmarkBtn');
                
                if (result.data) {
                    btn.innerHTML = '<span>â­</span><span>ë¶ë§ˆí¬</span>';
                    btn.className = 'px-4 py-2 border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition bg-yellow-50 text-yellow-600 border-yellow-200';
                } else {
                    btn.innerHTML = '<span>â˜†</span><span>ë¶ë§ˆí¬</span>';
                    btn.className = 'px-4 py-2 border rounded-lg flex items-center space-x-2 hover:bg-gray-50 transition bg-white text-gray-600';
                }
            } else if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
            }
        } catch (e) {
            console.error(e);
        }
    }
    
    // ê³µìœ 
    function sharePost() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(window.location.href);
            alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
    }
    
    // ëŒ“ê¸€ ì‘ì„±
    document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('commentInput');
        const content = input.value.trim();
        
        if (!content) return;
        
        try {
            const response = await fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ content })
            });
            
            if (response.ok) {
                location.reload();
            } else if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
            } else {
                const result = await response.json();
                alert(result.message || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            console.error(e);
            alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
</script>

</body>
</html>
