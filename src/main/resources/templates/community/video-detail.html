<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head(${video.title})}"></head>
<body class="bg-gray-900 min-h-screen">
    
    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- 동영상 -->
        <div class="lg:flex-1 bg-black flex items-center justify-center relative">
            <div class="w-full max-w-md mx-auto aspect-[9/16]">
                <video th:src="${video.videoPath}" class="w-full h-full object-contain" controls autoplay playsinline></video>
            </div>
            <a href="/" class="absolute top-4 left-4 text-white bg-black/50 p-2 rounded-full hover:bg-black/70">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
        </div>

        <!-- 정보 -->
        <div class="lg:w-96 bg-white lg:h-screen lg:overflow-y-auto">
            <div class="p-4">
                <!-- 작성자 -->
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-white font-medium">
                        <span th:text="${#strings.substring(video.authorName, 0, 1)}">U</span>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900" th:text="${video.authorName}">작성자</p>
                        <p class="text-xs text-gray-500" th:text="${#temporals.format(video.createdAt, 'yyyy.MM.dd')}">날짜</p>
                    </div>
                </div>

                <!-- 제목 & 설명 -->
                <h1 class="text-lg font-bold text-gray-900 mb-2" th:text="${video.title}">제목</h1>
                <p th:if="${video.description}" class="text-gray-600 text-sm mb-4" th:text="${video.description}">설명</p>

                <!-- 해시태그 -->
                <div th:if="${video.hashtagList != null and !video.hashtagList.isEmpty()}" class="flex flex-wrap gap-2 mb-4">
                    <span th:each="tag : ${video.hashtagList}" class="text-emerald-500 text-sm" th:text="${tag}">#태그</span>
                </div>

                <!-- 통계 -->
                <div class="flex items-center space-x-4 text-sm text-gray-500 mb-4 pb-4 border-b">
                    <span>조회 <strong th:text="${video.viewCount}">0</strong></span>
                    <span>좋아요 <strong th:text="${video.likeCount}" id="likeCount">0</strong></span>
                    <span>댓글 <strong th:text="${video.commentCount}">0</strong></span>
                </div>

                <!-- 액션 -->
                <div class="flex items-center space-x-2 mb-6">
                    <button onclick="toggleLike()" id="likeBtn"
                            th:class="${video.liked} ? 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-red-50 text-red-500 border-red-200' : 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-white text-gray-600 border-gray-200 hover:bg-gray-50'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                        <span>좋아요</span>
                    </button>
                    <button onclick="toggleBookmark()" id="bookmarkBtn"
                            th:class="${video.bookmarked} ? 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-yellow-50 text-yellow-600 border-yellow-200' : 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-white text-gray-600 border-gray-200 hover:bg-gray-50'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                        </svg>
                        <span>저장</span>
                    </button>
                    <button onclick="shareVideo()" class="p-2 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                        </svg>
                    </button>
                </div>

                <!-- 상품 링크 -->
                <div th:if="${video.productUrl}" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-500 mb-2">연관 상품</p>
                    <a th:href="${video.productUrl}" target="_blank" class="text-emerald-500 hover:text-emerald-600 text-sm flex items-center">
                        상품 보러가기
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                </div>

                <!-- 수정/삭제 -->
                <div sec:authorize="isAuthenticated()" th:if="${#authentication.principal.user.id == video.authorId}" class="flex space-x-2 mb-6">
                    <form th:action="@{/videos/{id}/delete(id=${video.id})}" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?')">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="text-sm text-red-500 hover:text-red-700">삭제</button>
                    </form>
                </div>

                <!-- 댓글 -->
                <div class="border-t pt-4">
                    <h3 class="font-medium text-gray-900 mb-4">댓글</h3>
                    <form sec:authorize="isAuthenticated()" id="commentForm" class="mb-4">
                        <div class="flex space-x-2">
                            <input type="text" id="commentInput" placeholder="댓글을 입력하세요" required
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500">
                            <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm hover:bg-emerald-600">등록</button>
                        </div>
                    </form>
                    <p sec:authorize="isAnonymous()" class="text-sm text-gray-500 mb-4">
                        <a href="/login" class="text-emerald-500">로그인</a> 후 댓글을 작성할 수 있습니다.
                    </p>
                    <div id="commentList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const videoId = [[${video.id}]];
        const csrfToken = [[${_csrf.token}]];
        const csrfHeader = [[${_csrf.headerName}]];
        let isLiked = [[${video.liked}]] || false;
        let isBookmarked = [[${video.bookmarked}]] || false;

        loadComments();

        async function toggleLike() {
            try {
                const res = await fetch(`/api/videos/${videoId}/like`, {
                    method: 'POST',
                    headers: { [csrfHeader]: csrfToken }
                });
                const data = await res.json();
                if (data.success) {
                    isLiked = data.data.liked;
                    document.getElementById('likeCount').textContent = data.data.likeCount;
                    updateLikeBtn();
                }
            } catch (e) { alert('로그인이 필요합니다.'); }
        }

        async function toggleBookmark() {
            try {
                const res = await fetch(`/api/videos/${videoId}/bookmark`, {
                    method: 'POST',
                    headers: { [csrfHeader]: csrfToken }
                });
                const data = await res.json();
                if (data.success) {
                    isBookmarked = data.data.bookmarked;
                    updateBookmarkBtn();
                }
            } catch (e) { alert('로그인이 필요합니다.'); }
        }

        function updateLikeBtn() {
            const btn = document.getElementById('likeBtn');
            btn.className = isLiked
                ? 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-red-50 text-red-500 border-red-200'
                : 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-white text-gray-600 border-gray-200 hover:bg-gray-50';
        }

        function updateBookmarkBtn() {
            const btn = document.getElementById('bookmarkBtn');
            btn.className = isBookmarked
                ? 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-yellow-50 text-yellow-600 border-yellow-200'
                : 'flex-1 flex items-center justify-center space-x-2 py-2 border rounded-lg bg-white text-gray-600 border-gray-200 hover:bg-gray-50';
        }

        function shareVideo() {
            if (navigator.share) {
                navigator.share({ title: document.title, url: location.href });
            } else {
                navigator.clipboard.writeText(location.href);
                alert('링크가 복사되었습니다.');
            }
        }

        async function loadComments() {
            const res = await fetch(`/api/videos/${videoId}/comments`);
            const data = await res.json();
            const list = document.getElementById('commentList');
            
            if (data.data.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">댓글이 없습니다.</p>';
                return;
            }
            
            list.innerHTML = data.data.map(c => `
                <div class="flex space-x-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm">${c.authorName.charAt(0)}</div>
                    <div class="flex-1">
                        <p class="text-sm"><strong>${c.authorName}</strong></p>
                        <p class="text-sm text-gray-600">${c.content}</p>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            if (!content) return;

            const res = await fetch(`/api/videos/${videoId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ content })
            });

            if (res.ok) {
                input.value = '';
                loadComments();
            }
        });
    </script>
</body>
</html>
